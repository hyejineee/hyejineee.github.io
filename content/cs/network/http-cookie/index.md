---
title: 'Http - cookie'
path: blog/cs-network/http-cookie
tags: [Network]
cover: './cover.png'
date: 2023-01-09
excerpt: 내가 만든 쿠키~🍪
draft : false
---

## 전쟁의 서막  


<p align="center">
    <img src="./1.png">
</p>

<br/>  
동기로부터 쿠키에 대한 질문에 날아왔습니다. 쿠키의 domain 속성에 어떤 값을 넣어야 하냐?에 대한 질문이었는데 일단 저희 프로젝트의 서버 코드를 찾아 백엔드 주솟값을 넣는다고 알려줬습니다.

정확히 쿠키가 어떻게 동작하는지에 대한 이해가 없었기 때문에 여러 궁금증이 생겼습니다. 왜 백엔드 주소가 들어가지? 저게 어떤 역할을 하는 속성이지?라는 질문과 함께 쿠키에 대한 공부를 시작했습니다.

공부하는 중간에 domain 옵션에 대한 오해와 오해를 풀어나가는 과정을 기록하고, 쿠키에 대한 기본적인 개념을 정리하고자 합니다.


## 기본 개념 

### 쿠키는 왜 사용하나요?

쿠키를 왜 사용하는지 알기 위해선 먼저 http의 특성을 이해해야 합니다. 

http는 비연결성으로 한 번의 요청-응답으로 연결이 끊기는 특징을 갖고 있습니다. 또 http는 상태를 유지하지 않는 프로토콜입니다. http 통신에서 서버와 클라이언트는 각자 보낸 요청과 응답에 대해서 기억하고 있지 않습니다. 과거에 대한 정보를 갖지 않도록 간단하게 설계됨으로써 http는 많은 데이터를 빠르고, 확실하게 처리하는 범위성을 확보할 수 있게 되었습니다. 

하지만 웹에서 사용자 편의를 위한 여러 작업을 처리하기 시작하면서 상태 저장에 대한 요구가 생기게 되었고, 이러한 요구에 따라 생겨난 것이 쿠키입니다. 쿠기는 사용자를 식별하고 세션을 유지하는 방식 중에서 현재까지 가장 널리 사용하는 방식입니다.

### 쿠키는 어떻게 사용되나요?

쿠키는 주로 서버에서 만들어 response의 헤더에 담아 클라이언트에 전달해 줍니다. 기본 동작은 다음 그림과 같습니다.


![](./cookie-operation-diagram.png)


1. 클라이언트에서 서버로 첫 요청을 보냅니다. 
2. 서버는 클라이언트의 요청을 처리하고 key, value 형태의 값을 Set-cookie 헤더에 기술합니다. 헤더는 클라이언트로 보내지는 응답 패킷에 설정되어 클라이언트로 보내집니다.
3. 클라이언트 단으로 도착한 응답 패킷은 먼저 브라우저를 거칩니다. 브라우저는 응답 패킷의 헤더에 있는 쿠키 값을 꺼내 브라우저의 쿠키 저장소에 저장해둡니다. 
4. 다시 클라이언트가 서버로 두 번째 요청을 보낼 때 브라우저는 저장해 두었던 쿠키 값을 꺼내 요청 패킷의 헤더에 자동으로 첨부합니다. 

이런 과정을 거쳐 클라이언트로부터 두 번째 요청을 받는 서버는 쿠키를 통해 클라이언트의 정보를 트래킹 할 수 있게 되고, 이 정보를 바탕으로 사용자를 식별하고 세션을 유지합니다.

응답 헤더에 첨부된 쿠키는 브라우저에서 도메인별로 저장합니다. 후에 그 도메인 서버로 요청이 있을 때 해당 도메인의 쿠키 저장소에서 쿠키를 꺼내 요청 패킷의 헤더에 설정합니다. 쿠키 저장소처럼 브라우저는 쿠키 정보를 저장할 책임이 있는데 이 시스템을 `클라이언트 측 상태`라고 합니다. 각 브라우저는 각기 다른 방식으로 쿠키를 저장하는데 대표적으로 크롬은 Cookies라는 SQLite 파일에 쿠키를 저장합니다. 


### 쿠키의 기본적 형태

쿠키는 응답 헤더에 사용될 때, 요청 헤더에 사용될 때 다음과 같은 형태로 사용됩니다.  

* 응답 헤더에서 사용 시 

```javascript
Set-Cookie: 이름=값 ; domain=.example.com ; path=/; Expires=Wed, 21 Oct 2015 07:28:00 GMT; Max-Age=3600; Secure; HttpOnly
Set-Cookie: 이름=값
Set-Cookie: 이름=값
```

* 요청 헤더에서 사용 시 

```javascript
Cookie: <이름>=<값>; <이름>=<값>; <이름>=<값>
```

### 옵션

응답 헤더에 Set-Cookie를 사용하여 쿠키 설정 시 domain, path, expires, max-age, secure, httpOnly, SameSite 옵션을 설정하여 쿠키의 사용 범위, 라이프 타임, 보안 등을 구체적으로 설정할 수 있습니다. 옵션들은 생략 가능합니다.

### 쿠키의 라이프 타임

쿠키의 라이프 타임에 관여하는 옵션에는 Expires와 Max-Age가 있습니다. 두 옵션 모두 값이 있을 때 브라우저는 Max-Age 값을 더 우선시 합니다. 

* Expires : 
    * 쿠키의 최대 생존 시간(수명, HTTP 타임스탬프로 기록. 과거 시간으로 지정할 경우 바로 삭제됨).
    * Expires 옵션 사용 시 반드시 GMT 포맷을 사용해야 합니다. 

```javascript
// 2015년 10월 21일에 쿠키가 만료됨 (삭제)
Expires=Wed, 21 Oct 2015 07:28:00 GMT; 
```

* Max-Age : 
    * 쿠키가 만료될 때 까지의 시간 (초 단위. 0이나 음수 값일 경우 쿠키는 바로 삭제됨)

```javascript
// 1시간 후에 쿠키가 만료됨 (삭제)
Max-Age=3600;
```

쿠키의 라이프 타임은 쿠키의 타입을 나누는 기준이 되기도 합니다.

* 세션 쿠키 (session cookie) : 
    * Expires 또는 Max-Age 옵션이 없는 쿠키 
    * 사용자가 사이트를 탐색할 때, 관련한 설정과 선호 사항들을 저장하는 임시 쿠키. 브라우저를 닫으면 삭제됨.  

    
* 지속 쿠키 (persistent cookie) : 
    * Expires 또는 Max-Age 옵션이 있는 쿠키 
    * 브라우저를 닫아도 쿠키가 삭제되지 않음.


### 쿠키의 범위

쿠키를 공부하면서 가장 헤맸던 부분입니다. 쿠키를 어떤 사이트에서 쓸 수 있는지를 결정하는 옵션인데 쿠키의 기본적인 동작을 생각하지 않고 🍪사용한다!🍪 에만 집중해서 보느라 옵션의 의미를 제대로 파악하지 못했던 것 같습니다. 또 기본적인 용어에 대해서 정확히 알았더라면 좀 더 이해가 빠르지 않았을까 싶습니다.

쿠키의 범위를 결정하는 옵션은 Domain과 Path가 있습니다. 먼저 참고한 사이트 및 자료들에서 Domain 옵션을 어떻게 정의하고 있는지 보겠습니다.

> 쿠키가 적용되어야 하는 호스트를 지정. 지정되어 있지 않으면 현재 문서 URI를 기준으로 적용됩니다만, 서브 도메인을 포함하지 않습니다. 이전의 설계와 달리, 도메인의 선두에 위치한 점들은 무시됩니다. 도메인이 지정되면, 서브도메인들은 항상 포함됩니다.   
>  
> 출저 : MDN

> 서버는 쿠키를 생성할 때 Set-Cookie 응답 헤더에 Domain 속성을 기술해서 어떤 사이트가 그 쿠키를 읽을 수 있는지 제어할 수 있다. 예를 들어 다음 HTTP 응답 헤더는 브라우저가 user='mary17' 이라는 쿠키를 .airtravelbargains.com 도메인을 가지고 있는 모든 사이트에 전달한다는 의미다.
>
> Set-cookie : user="mary17" ; domain=".airtravelbargains.com"
>    
> 만약 사용자가 www.airtravelbargains.com나 specials.airtravelbargains.com 같이 .airtravelbargains.com 으로 끝나는 사이트를 방문하면 다음 Cookie 헤더가 항상 적용될 것이다.   
>
> Cookie : user="mary17"
>  
> 출저 : HTTP 완벽 가이드 - 웹은 어떻게 동작하는가?  


음... 차근차근하게 정의들을 보니 한 번 쓱 훓고 헛다리를 너무 많이 짚었다는 생각이 듭니다.  

제가 오해한 domain은 쿠키에 접근해서 보는 곳은 클라이언트이니 백엔드 도메인이 아니라 클라이언트의 도메인이 들어가야 하는 거 아닌가?였습니다. 진행되는 프로젝트가 서버와 클라이언트의 도메인 주소가 달랐기 때문에 서버의 도메인으로 값을 설정하면 클라에서는 접근할 수 었는게 아닌가? 라는 생각이 들었습니다.

 클라이언트와 서버 사이에서 브라우저가 하는 역할을 제대로 파악하지 못하고 클라이언트가 쿠키를 갖고 있다가 서버의 요청에 건네주는 동작으로 오해 했습니다. 그래서 응답 헤더의 domain 옵션과 클라이언트의 도메인의 값이 일치하는지 확인하고 브라우저에 저장하는 것으로 오해했습니다.

어떤 점을 오해했는지 구체적으로 적으니 쥐구멍에 숨고 싶네여.

<p align="center">
    <img src="./2.jpeg">
</p>

먼저 MDN의 정의를 살펴 보겠습니다. 

* domain : 쿠키가 적용되어야 하는 호스트를 지정

호스트는 어디를 가리키는 말일까요? ~~이거부터 생각해 봤어야 했...~~ 일반적으로 호스트는 네트워크/ 인터넷을 통해 다른 컴퓨터들과 쌍방향 통신이 가능한 컴퓨터. 즉, 네트워크에 연결된 장치를 의미한다고 합니다. 하지만 이 정의는 너무 범위가 넓으니 호스트를 네트워크 요청 헤더에 사용하는 호스트로 범위를 축소해서 생각해보겠습니다. 

> Host 요청 헤더는 서버의 도메인명과 서버가 리스닝하는 TCP 포트를 특정합니다. 포트가 주어지지 않으면, 요청된 서버의 기본 포트를 의미합니다.
>
> 출저 : MDN
 
이렇게 호스트의 의미를 정의하고 나니 좀 더 이해하기 쉬워진 것 같습니다. 네. 서버 도메인의 주소를 적어줘야 합니다. 


## Ref.
- https://developer.mozilla.org/ko/docs/Web/HTTP/Cookies
- https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Set-Cookie
- https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Host


